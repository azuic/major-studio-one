{"version":3,"sources":["../../../src/lib/layer.js"],"names":["LOG_PRIORITY_UPDATE","EMPTY_ARRAY","Object","freeze","pickingColorCache","Uint8ClampedArray","defaultProps","data","type","value","async","dataComparator","_dataDiff","__diff","compare","optional","dataTransform","onDataLoad","fetch","url","layer","getLoadOptions","updateTriggers","numInstances","undefined","visible","pickable","opacity","min","max","onHover","onClick","onDragStart","onDrag","onDragEnd","coordinateSystem","COORDINATE_SYSTEM","LNGLAT","coordinateOrigin","modelMatrix","wrapLongitude","positionFormat","colorFormat","parameters","uniforms","extensions","framebuffer","animation","getPolygonOffset","layerIndex","highlightedObjectIndex","autoHighlight","highlightColor","Layer","className","constructor","layerName","name","props","id","updateObject","setChangeFlags","stateChanged","assign","state","setNeedsRedraw","redraw","internalState","needsRedraw","context","layerManager","setNeedsUpdate","String","opts","clearRedrawFlags","_getNeedsRedraw","shouldUpdateState","_getUpdateParams","models","model","attributeManager","loadOptions","object","xyz","viewport","worldPosition","pixelProjectionMatrix","x","y","z","length","xy","Array","isArray","unproject","lngLat","log","deprecated","projectFlat","unprojectFlat","IDENTITY","screenPixels","devicePixelRatio","window","info","pickingEvent","i","target","color","Uint8Array","i1","i2","i3","index","Error","shaders","extension","getShaders","call","oldProps","changeFlags","propsOrDataChanged","getAttributeManager","dataChanged","dataRange","invalidateAll","getModels","delete","finalize","draw","mode","diffReason","invalidate","changedAttributes","_setModelAttributes","getNumInstances","bufferLayout","getBufferLayout","update","transitions","buffers","ignoreUnknownAttributes","getChangedAttributes","clearChangedFlags","updateAttributes","updateTransition","time","attribute","startRow","endRow","size","cacheSize","newPickingColorCache","set","pickingColor","encodePickingColor","Math","subarray","shaderAttributes","excludeAttributes","userData","attributeName","getShaderAttributes","setAttributes","instancePickingColors","attributes","decodePickingColor","pickingColors","_clearPickingColor","_clearInstancePickingColor","colors","oldValue","_initState","initializeState","propsChanged","viewportChanged","extensionsChanged","_updateState","getSingleModel","program","stateNeedsUpdate","needsUpdate","updateParams","gl","updateState","error","isComposite","_renderLayers","_updateAttributes","_updateBaseUniforms","setInstanceCount","clearChangeFlags","resetOldProps","finalizeState","moduleParameters","picking_uActive","setModuleParameters","animationProps","_setAnimationProps","offsets","polygonOffset","getPickingInfo","flags","updateTriggersChanged","keys","join","somethingChanged","newProps","key","_activeUpdateTrigger","updateModuleSettings","getOldProps","attributeManagerNeedsRedraw","getNeedsRedraw","AttributeManager","stats","_getAttributeManager","addInstanced","calculateInstancePickingColors","LayerState","onAsyncPropUpdated","_onAsyncPropUpdated","bind","setAsyncProps","oldLayer","component","diffProps","setLayerNeedsUpdate","propName","invalidateAttribute","pow","setUniforms","uniformMap","removed","Component"],"mappings":"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","sourcesContent":["// Copyright (c) 2015 - 2017 Uber Technologies, Inc.\n//\n// Permission is hereby granted, free of charge, to any person obtaining a copy\n// of this software and associated documentation files (the \"Software\"), to deal\n// in the Software without restriction, including without limitation the rights\n// to use, copy, modify, merge, publish, distribute, sublicense, and/or sell\n// copies of the Software, and to permit persons to whom the Software is\n// furnished to do so, subject to the following conditions:\n//\n// The above copyright notice and this permission notice shall be included in\n// all copies or substantial portions of the Software.\n//\n// THE SOFTWARE IS PROVIDED \"AS IS\", WITHOUT WARRANTY OF ANY KIND, EXPRESS OR\n// IMPLIED, INCLUDING BUT NOT LIMITED TO THE WARRANTIES OF MERCHANTABILITY,\n// FITNESS FOR A PARTICULAR PURPOSE AND NONINFRINGEMENT. IN NO EVENT SHALL THE\n// AUTHORS OR COPYRIGHT HOLDERS BE LIABLE FOR ANY CLAIM, DAMAGES OR OTHER\n// LIABILITY, WHETHER IN AN ACTION OF CONTRACT, TORT OR OTHERWISE, ARISING FROM,\n// OUT OF OR IN CONNECTION WITH THE SOFTWARE OR THE USE OR OTHER DEALINGS IN\n// THE SOFTWARE.\n\n/* eslint-disable react/no-direct-mutation-state */\n/* global window */\nimport {COORDINATE_SYSTEM} from './constants';\nimport AttributeManager from './attribute-manager';\nimport {removeLayerInSeer} from './seer-integration';\nimport {diffProps, validateProps} from '../lifecycle/props';\nimport {count} from '../utils/count';\nimport log from '../utils/log';\nimport GL from '@luma.gl/constants';\nimport {withParameters} from '@luma.gl/core';\nimport assert from '../utils/assert';\nimport {mergeShaders} from '../utils/shader';\nimport {projectPosition, getWorldPosition} from '../shaderlib/project/project-functions';\n\nimport Component from '../lifecycle/component';\nimport LayerState from './layer-state';\n\nimport {worldToPixels} from 'viewport-mercator-project';\n\nimport {load} from '@loaders.gl/core';\n\nconst LOG_PRIORITY_UPDATE = 1;\n\nconst EMPTY_ARRAY = Object.freeze([]);\n\nlet pickingColorCache = new Uint8ClampedArray(0);\n\nconst defaultProps = {\n  // data: Special handling for null, see below\n  data: {type: 'data', value: EMPTY_ARRAY, async: true},\n  dataComparator: null,\n  _dataDiff: {type: 'function', value: data => data && data.__diff, compare: false, optional: true},\n  dataTransform: {type: 'function', value: null, compare: false, optional: true},\n  onDataLoad: {type: 'function', value: null, compare: false, optional: true},\n  fetch: {\n    type: 'function',\n    value: (url, {layer}) => load(url, layer.getLoadOptions()),\n    compare: false\n  },\n  updateTriggers: {}, // Update triggers: a core change detection mechanism in deck.gl\n  numInstances: undefined,\n\n  visible: true,\n  pickable: false,\n  opacity: {type: 'number', min: 0, max: 1, value: 0.8},\n\n  onHover: {type: 'function', value: null, compare: false, optional: true},\n  onClick: {type: 'function', value: null, compare: false, optional: true},\n  onDragStart: {type: 'function', value: null, compare: false, optional: true},\n  onDrag: {type: 'function', value: null, compare: false, optional: true},\n  onDragEnd: {type: 'function', value: null, compare: false, optional: true},\n\n  coordinateSystem: COORDINATE_SYSTEM.LNGLAT,\n  coordinateOrigin: {type: 'array', value: [0, 0, 0], compare: true},\n  modelMatrix: {type: 'array', value: null, compare: true, optional: true},\n  wrapLongitude: false,\n  positionFormat: 'XYZ',\n  colorFormat: 'RGBA',\n\n  parameters: {},\n  uniforms: {},\n  extensions: [],\n  framebuffer: null,\n\n  animation: null, // Passed prop animation functions to evaluate props\n\n  // Offset depth based on layer index to avoid z-fighting.\n  // Negative values pull layer towards the camera\n  // https://www.opengl.org/archives/resources/faq/technical/polygonoffset.htm\n  getPolygonOffset: {\n    type: 'function',\n    value: ({layerIndex}) => [0, -layerIndex * 100],\n    compare: false\n  },\n\n  // Selection/Highlighting\n  highlightedObjectIndex: null,\n  autoHighlight: false,\n  highlightColor: {type: 'color', value: [0, 0, 128, 128]}\n};\n\nexport default class Layer extends Component {\n  toString() {\n    const className = this.constructor.layerName || this.constructor.name;\n    return `${className}({id: '${this.props.id}'})`;\n  }\n\n  // Public API\n\n  // Updates selected state members and marks the object for redraw\n  setState(updateObject) {\n    this.setChangeFlags({stateChanged: true});\n    Object.assign(this.state, updateObject);\n    this.setNeedsRedraw();\n  }\n\n  // Sets the redraw flag for this layer, will trigger a redraw next animation frame\n  setNeedsRedraw(redraw = true) {\n    if (this.internalState) {\n      this.internalState.needsRedraw = redraw;\n    }\n  }\n\n  // This layer needs a deep update\n  // TODO - Need to align with existing needsUpdate before uncommenting\n  // For now async props will call layerManager directly\n  setLayerNeedsUpdate() {\n    this.context.layerManager.setNeedsUpdate(String(this));\n  }\n\n  // Checks state of attributes and model\n  getNeedsRedraw(opts = {clearRedrawFlags: false}) {\n    return this._getNeedsRedraw(opts);\n  }\n\n  // Checks if layer attributes needs updating\n  needsUpdate() {\n    // Call subclass lifecycle method\n    return this.shouldUpdateState(this._getUpdateParams());\n    // End lifecycle method\n  }\n\n  // Returns true if the layer is pickable and visible.\n  isPickable() {\n    return this.props.pickable && this.props.visible;\n  }\n\n  // Return an array of models used by this layer, can be overriden by layer subclass\n  getModels() {\n    return this.state && (this.state.models || (this.state.model ? [this.state.model] : []));\n  }\n\n  // TODO - Gradually phase out, does not support multi model layers\n  getSingleModel() {\n    return this.state && this.state.model;\n  }\n\n  getAttributeManager() {\n    return this.internalState && this.internalState.attributeManager;\n  }\n\n  // Returns the most recent layer that matched to this state\n  // (When reacting to an async event, this layer may no longer be the latest)\n  getCurrentLayer() {\n    return this.internalState && this.internalState.layer;\n  }\n\n  // Returns the default parse options for async props\n  getLoadOptions() {\n    return this.props.loadOptions;\n  }\n\n  // Use iteration (the only required capability on data) to get first element\n  // deprecated since we are effectively only supporting Arrays\n  getFirstObject() {\n    const {data} = this.props;\n    for (const object of data) {\n      return object;\n    }\n    return null;\n  }\n\n  // PROJECTION METHODS\n\n  // Projects a point with current map state (lat, lon, zoom, pitch, bearing)\n  // From the current layer's coordinate system to screen\n  project(xyz) {\n    const {viewport} = this.context;\n    const worldPosition = getWorldPosition(xyz, {\n      viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n    const [x, y, z] = worldToPixels(worldPosition, viewport.pixelProjectionMatrix);\n    return xyz.length === 2 ? [x, y] : [x, y, z];\n  }\n\n  // Note: this does not reverse `project`.\n  // Always unprojects to the viewport's coordinate system\n  unproject(xy) {\n    const {viewport} = this.context;\n    assert(Array.isArray(xy));\n    return viewport.unproject(xy);\n  }\n\n  projectPosition(xyz) {\n    assert(Array.isArray(xyz));\n\n    return projectPosition(xyz, {\n      viewport: this.context.viewport,\n      modelMatrix: this.props.modelMatrix,\n      coordinateOrigin: this.props.coordinateOrigin,\n      coordinateSystem: this.props.coordinateSystem\n    });\n  }\n\n  // DEPRECATE: This does not handle offset modes\n  projectFlat(lngLat) {\n    log.deprecated('layer.projectFlat', 'layer.projectPosition')();\n    const {viewport} = this.context;\n    assert(Array.isArray(lngLat));\n    return viewport.projectFlat(lngLat);\n  }\n\n  // DEPRECATE: This is not meaningful in offset modes\n  unprojectFlat(xy) {\n    log.deprecated('layer.unprojectFlat')();\n    const {viewport} = this.context;\n    assert(Array.isArray(xy));\n    return viewport.unprojectFlat(xy);\n  }\n\n  use64bitPositions() {\n    return (\n      this.props.coordinateSystem === COORDINATE_SYSTEM.LNGLAT ||\n      this.props.coordinateSystem === COORDINATE_SYSTEM.IDENTITY\n    );\n  }\n\n  // TODO - needs to refer to context for devicePixels setting\n  screenToDevicePixels(screenPixels) {\n    log.deprecated('screenToDevicePixels', 'DeckGL prop useDevicePixels for conversion')();\n    const devicePixelRatio = typeof window !== 'undefined' ? window.devicePixelRatio : 1;\n    return screenPixels * devicePixelRatio;\n  }\n\n  // Event handling\n  onHover(info, pickingEvent) {\n    if (this.props.onHover) {\n      return this.props.onHover(info, pickingEvent);\n    }\n    return false;\n  }\n\n  onClick(info, pickingEvent) {\n    if (this.props.onClick) {\n      return this.props.onClick(info, pickingEvent);\n    }\n    return false;\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  // @return {Array} - a black color\n  nullPickingColor() {\n    return [0, 0, 0];\n  }\n\n  // Returns the picking color that doesn't match any subfeature\n  // Use if some graphics do not belong to any pickable subfeature\n  encodePickingColor(i, target = []) {\n    assert(i < 16777215, 'index out of picking color range');\n    target[0] = (i + 1) & 255;\n    target[1] = ((i + 1) >> 8) & 255;\n    target[2] = (((i + 1) >> 8) >> 8) & 255;\n    return target;\n  }\n\n  // Returns the index corresponding to a picking color that doesn't match any subfeature\n  // @param {Uint8Array} color - color array to be decoded\n  // @return {Array} - the decoded picking color\n  decodePickingColor(color) {\n    assert(color instanceof Uint8Array);\n    const [i1, i2, i3] = color;\n    // 1 was added to seperate from no selection\n    const index = i1 + i2 * 256 + i3 * 65536 - 1;\n    return index;\n  }\n\n  // //////////////////////////////////////////////////\n  // LIFECYCLE METHODS, overridden by the layer subclasses\n\n  // Called once to set up the initial state\n  // App can create WebGL resources\n  initializeState() {\n    throw new Error(`Layer ${this} has not defined initializeState`);\n  }\n\n  getShaders(shaders) {\n    for (const extension of this.props.extensions) {\n      shaders = mergeShaders(shaders, extension.getShaders.call(this, extension));\n    }\n    return shaders;\n  }\n\n  // Let's layer control if updateState should be called\n  shouldUpdateState({oldProps, props, context, changeFlags}) {\n    return changeFlags.propsOrDataChanged;\n  }\n\n  // Default implementation, all attributes will be invalidated and updated\n  // when data changes\n  updateState({oldProps, props, context, changeFlags}) {\n    const attributeManager = this.getAttributeManager();\n    if (changeFlags.dataChanged && attributeManager) {\n      const {dataChanged} = changeFlags;\n      if (Array.isArray(dataChanged)) {\n        // is partial update\n        for (const dataRange of dataChanged) {\n          attributeManager.invalidateAll(dataRange);\n        }\n      } else {\n        attributeManager.invalidateAll();\n      }\n    }\n  }\n\n  // Called once when layer is no longer matched and state will be discarded\n  // App can destroy WebGL resources here\n  finalizeState() {\n    for (const model of this.getModels()) {\n      model.delete();\n    }\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.finalize();\n    }\n  }\n\n  // If state has a model, draw it with supplied uniforms\n  draw(opts) {\n    for (const model of this.getModels()) {\n      model.draw(opts);\n    }\n  }\n\n  // called to populate the info object that is passed to the event handler\n  // @return null to cancel event\n  getPickingInfo({info, mode}) {\n    const {index} = info;\n\n    if (index >= 0) {\n      // If props.data is an indexable array, get the object\n      if (Array.isArray(this.props.data)) {\n        info.object = this.props.data[index];\n      }\n    }\n\n    return info;\n  }\n\n  // END LIFECYCLE METHODS\n  // //////////////////////////////////////////////////\n\n  // INTERNAL METHODS\n\n  // Default implementation of attribute invalidation, can be redefined\n  invalidateAttribute(name = 'all', diffReason = '') {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    if (name === 'all') {\n      log.log(LOG_PRIORITY_UPDATE, `updateTriggers invalidating all attributes: ${diffReason}`)();\n      attributeManager.invalidateAll();\n    } else {\n      log.log(\n        LOG_PRIORITY_UPDATE,\n        `updateTriggers invalidating attribute ${name}: ${diffReason}`\n      )();\n      attributeManager.invalidate(name);\n    }\n  }\n\n  updateAttributes(changedAttributes) {\n    for (const model of this.getModels()) {\n      this._setModelAttributes(model, changedAttributes);\n    }\n  }\n\n  // Calls attribute manager to update any WebGL attributes\n  _updateAttributes(props) {\n    const attributeManager = this.getAttributeManager();\n    if (!attributeManager) {\n      return;\n    }\n\n    // Figure out data length\n    const numInstances = this.getNumInstances(props);\n    const bufferLayout = this.getBufferLayout(props);\n\n    attributeManager.update({\n      data: props.data,\n      numInstances,\n      bufferLayout,\n      props,\n      transitions: props.transitions,\n      buffers: props,\n      context: this,\n      // Don't worry about non-attribute props\n      ignoreUnknownAttributes: true\n    });\n\n    const changedAttributes = attributeManager.getChangedAttributes({clearChangedFlags: true});\n    this.updateAttributes(changedAttributes);\n  }\n\n  // Update attribute transition\n  updateTransition() {\n    const attributeManager = this.getAttributeManager();\n    if (attributeManager) {\n      attributeManager.updateTransition(this.context.time);\n    }\n  }\n\n  calculateInstancePickingColors(attribute, {numInstances, startRow, endRow}) {\n    const {value, size} = attribute;\n\n    // calculateInstancePickingColors always generates the same sequence.\n    // pickingColorCache saves the largest generated sequence for reuse\n    const cacheSize = pickingColorCache.length / size;\n\n    if (cacheSize < numInstances) {\n      // If the attribute is larger than the cache, resize the cache and populate the missing chunk\n      const newPickingColorCache = new Uint8ClampedArray(numInstances * size);\n      newPickingColorCache.set(pickingColorCache);\n      const pickingColor = [];\n\n      for (let i = cacheSize; i < numInstances; i++) {\n        this.encodePickingColor(i, pickingColor);\n        newPickingColorCache[i * size + 0] = pickingColor[0];\n        newPickingColorCache[i * size + 1] = pickingColor[1];\n        newPickingColorCache[i * size + 2] = pickingColor[2];\n      }\n\n      pickingColorCache = newPickingColorCache;\n    }\n\n    // Copy the last calculated picking color sequence into the attribute\n    endRow = Math.min(endRow, numInstances);\n    value.set(pickingColorCache.subarray(startRow * size, endRow * size));\n  }\n\n  _setModelAttributes(model, changedAttributes) {\n    const shaderAttributes = {};\n    const excludeAttributes = model.userData.excludeAttributes || {};\n    for (const attributeName in changedAttributes) {\n      if (!excludeAttributes[attributeName]) {\n        Object.assign(shaderAttributes, changedAttributes[attributeName].getShaderAttributes());\n      }\n    }\n\n    model.setAttributes(shaderAttributes);\n  }\n\n  // Sets the specified instanced picking color to null picking color. Used for multi picking.\n  _clearInstancePickingColor(color) {\n    const {instancePickingColors} = this.getAttributeManager().attributes;\n    const {value, size} = instancePickingColors;\n\n    const i = this.decodePickingColor(color);\n    value[i * size + 0] = 0;\n    value[i * size + 1] = 0;\n    value[i * size + 2] = 0;\n\n    // TODO: Optimize this to use sub-buffer update!\n    instancePickingColors.update({value});\n  }\n\n  // Sets all occurrences of the specified picking color to null picking color. Used for multi picking.\n  _clearPickingColor(color) {\n    const {pickingColors} = this.getAttributeManager().attributes;\n    const {value} = pickingColors;\n\n    for (let i = 0; i < value.length; i += 3) {\n      if (value[i + 0] === color[0] && value[i + 1] === color[1] && value[i + 2] === color[2]) {\n        value[i + 0] = 0;\n        value[i + 1] = 0;\n        value[i + 2] = 0;\n      }\n    }\n\n    // TODO: Optimize this to use sub-buffer update!\n    pickingColors.update({value});\n  }\n\n  // This method figures out if we use instance colors or not\n  // and calls _clearInstancePickingColor or _clearPickingColor\n  clearPickingColor(color) {\n    if (this.getAttributeManager().attributes.pickingColors) {\n      this._clearPickingColor(color);\n    } else {\n      this._clearInstancePickingColor(color);\n    }\n  }\n\n  copyPickingColors() {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    return new Uint8ClampedArray(colors.value);\n  }\n\n  restorePickingColors(oldValue) {\n    const {pickingColors, instancePickingColors} = this.getAttributeManager().attributes;\n    const colors = pickingColors || instancePickingColors;\n\n    const {value} = colors;\n    // Make sure the attribute's allocated buffer contains the correct value\n    value.set(oldValue);\n    colors.update({value});\n  }\n\n  // Deduces numer of instances. Intention is to support:\n  // - Explicit setting of numInstances\n  // - Auto-deduction for ES6 containers that define a size member\n  // - Auto-deduction for Classic Arrays via the built-in length attribute\n  // - Auto-deduction via arrays\n  getNumInstances(props) {\n    props = props || this.props;\n\n    // First Check if app has provided an explicit value\n    if (props.numInstances !== undefined) {\n      return props.numInstances;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.numInstances !== undefined) {\n      return this.state.numInstances;\n    }\n\n    // Use container library to get a count for any ES6 container or object\n    const {data} = this.props;\n    return count(data);\n  }\n\n  // Buffer layout describes how many attribute values are packed for each data object\n  // The default (null) is one value each object.\n  // Some data formats (e.g. paths, polygons) have various length. Their buffer layout\n  //  is in the form of [L0, L1, L2, ...]\n  getBufferLayout(props) {\n    props = props || this.props;\n\n    // First Check if bufferLayout is provided as an explicit value\n    if (props.bufferLayout !== undefined) {\n      return props.bufferLayout;\n    }\n\n    // Second check if the layer has set its own value\n    if (this.state && this.state.bufferLayout !== undefined) {\n      return this.state.bufferLayout;\n    }\n\n    return null;\n  }\n\n  // LAYER MANAGER API\n  // Should only be called by the deck.gl LayerManager class\n\n  // Called by layer manager when a new layer is found\n  /* eslint-disable max-statements */\n  _initialize() {\n    this._initState();\n\n    // Call subclass lifecycle methods\n    this.initializeState(this.context);\n    // Initialize extensions\n    for (const extension of this.props.extensions) {\n      extension.initializeState.call(this, this.context, extension);\n    }\n    // End subclass lifecycle methods\n\n    // TODO deprecated, for backwards compatibility with older layers\n    // in case layer resets state\n    this.state.attributeManager = this.getAttributeManager();\n\n    // initializeState callback tends to clear state\n    this.setChangeFlags({\n      dataChanged: true,\n      propsChanged: true,\n      viewportChanged: true,\n      extensionsChanged: true\n    });\n\n    this._updateState();\n\n    const model = this.getSingleModel();\n    if (model) {\n      model.id = this.props.id;\n      model.program.id = `${this.props.id}-program`;\n    }\n  }\n\n  // Called by layer manager\n  // if this layer is new (not matched with an existing layer) oldProps will be empty object\n  _update() {\n    // Call subclass lifecycle method\n    const stateNeedsUpdate = this.needsUpdate();\n    // End lifecycle method\n\n    if (stateNeedsUpdate) {\n      this._updateState();\n    }\n  }\n  /* eslint-enable max-statements */\n\n  // Common code for _initialize and _update\n  _updateState() {\n    const updateParams = this._getUpdateParams();\n\n    // Safely call subclass lifecycle methods\n    if (this.context.gl) {\n      this.updateState(updateParams);\n    } else {\n      try {\n        this.updateState(updateParams);\n      } catch (error) {\n        // ignore error if gl context is missing\n      }\n    }\n    // Execute extension updates\n    for (const extension of this.props.extensions) {\n      extension.updateState.call(this, updateParams, extension);\n    }\n    // End subclass lifecycle methods\n\n    if (this.isComposite) {\n      // Render or update previously rendered sublayers\n      this._renderLayers(updateParams);\n    } else {\n      this.setNeedsRedraw();\n      // Add any subclass attributes\n      this._updateAttributes(this.props);\n      this._updateBaseUniforms();\n\n      // Note: Automatic instance count update only works for single layers\n      if (this.state.model) {\n        this.state.model.setInstanceCount(this.getNumInstances());\n      }\n    }\n\n    this.clearChangeFlags();\n    this.internalState.resetOldProps();\n  }\n\n  // Called by manager when layer is about to be disposed\n  // Note: not guaranteed to be called on application shutdown\n  _finalize() {\n    assert(this.internalState && this.state);\n\n    // Call subclass lifecycle method\n    this.finalizeState(this.context);\n    // Finalize extensions\n    for (const extension of this.props.extensions) {\n      extension.finalizeState.call(this, extension);\n    }\n    // End lifecycle method\n    removeLayerInSeer(this.id);\n  }\n\n  // Calculates uniforms\n  drawLayer({moduleParameters = null, uniforms = {}, parameters = {}}) {\n    if (!uniforms.picking_uActive) {\n      this.updateTransition();\n    }\n\n    // TODO/ib - hack move to luma Model.draw\n    if (moduleParameters) {\n      this.setModuleParameters(moduleParameters);\n    }\n\n    // Hack/ib - define a public luma function\n    const {animationProps} = this.context;\n    if (animationProps) {\n      for (const model of this.getModels()) {\n        model._setAnimationProps(animationProps);\n      }\n    }\n\n    // Apply polygon offset to avoid z-fighting\n    // TODO - move to draw-layers\n    const {getPolygonOffset} = this.props;\n    const offsets = (getPolygonOffset && getPolygonOffset(uniforms)) || [0, 0];\n    parameters.polygonOffset = offsets;\n\n    // Call subclass lifecycle method\n    withParameters(this.context.gl, parameters, () => {\n      this.draw({moduleParameters, uniforms, parameters, context: this.context});\n    });\n    // End lifecycle method\n  }\n\n  // {uniforms = {}, ...opts}\n  pickLayer(opts) {\n    // Call subclass lifecycle method\n    return this.getPickingInfo(opts);\n    // End lifecycle method\n  }\n\n  // Helper methods\n  getChangeFlags() {\n    return this.internalState.changeFlags;\n  }\n\n  // Dirty some change flags, will be handled by updateLayer\n  /* eslint-disable complexity */\n  setChangeFlags(flags) {\n    this.internalState.changeFlags = this.internalState.changeFlags || {};\n    const changeFlags = this.internalState.changeFlags;\n\n    // Update primary flags\n    if (flags.dataChanged && !changeFlags.dataChanged) {\n      changeFlags.dataChanged = flags.dataChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `dataChanged: ${flags.dataChanged} in ${this.id}`)();\n    }\n    if (flags.updateTriggersChanged && !changeFlags.updateTriggersChanged) {\n      changeFlags.updateTriggersChanged =\n        changeFlags.updateTriggersChanged && flags.updateTriggersChanged\n          ? Object.assign({}, flags.updateTriggersChanged, changeFlags.updateTriggersChanged)\n          : flags.updateTriggersChanged || changeFlags.updateTriggersChanged;\n      log.log(\n        LOG_PRIORITY_UPDATE + 1,\n        () =>\n          'updateTriggersChanged: ' +\n          `${Object.keys(flags.updateTriggersChanged).join(', ')} in ${this.id}`\n      )();\n    }\n    if (flags.propsChanged && !changeFlags.propsChanged) {\n      changeFlags.propsChanged = flags.propsChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `propsChanged: ${flags.propsChanged} in ${this.id}`)();\n    }\n    if (flags.extensionsChanged && !changeFlags.extensionsChanged) {\n      changeFlags.extensionsChanged = flags.extensionsChanged;\n      log.log(\n        LOG_PRIORITY_UPDATE + 1,\n        () => `extensionsChanged: ${flags.extensionsChanged} in ${this.id}`\n      )();\n    }\n    if (flags.viewportChanged && !changeFlags.viewportChanged) {\n      changeFlags.viewportChanged = flags.viewportChanged;\n      log.log(\n        LOG_PRIORITY_UPDATE + 2,\n        () => `viewportChanged: ${flags.viewportChanged} in ${this.id}`\n      )();\n    }\n    if (flags.stateChanged && !changeFlags.stateChanged) {\n      changeFlags.stateChanged = flags.stateChanged;\n      log.log(LOG_PRIORITY_UPDATE + 1, () => `stateChanged: ${flags.stateChanged} in ${this.id}`)();\n    }\n\n    // Update composite flags\n    const propsOrDataChanged =\n      flags.dataChanged ||\n      flags.updateTriggersChanged ||\n      flags.propsChanged ||\n      flags.extensionsChanged;\n    changeFlags.propsOrDataChanged = changeFlags.propsOrDataChanged || propsOrDataChanged;\n    changeFlags.somethingChanged =\n      changeFlags.somethingChanged ||\n      propsOrDataChanged ||\n      flags.viewportChanged ||\n      flags.stateChanged;\n  }\n  /* eslint-enable complexity */\n\n  // Clear all changeFlags, typically after an update\n  clearChangeFlags() {\n    this.internalState.changeFlags = {\n      // Primary changeFlags, can be strings stating reason for change\n      dataChanged: false,\n      propsChanged: false,\n      updateTriggersChanged: false,\n      viewportChanged: false,\n      stateChanged: false,\n      extensionsChanged: false,\n\n      // Derived changeFlags\n      propsOrDataChanged: false,\n      somethingChanged: false\n    };\n  }\n\n  printChangeFlags() {\n    const flags = this.internalState.changeFlags;\n    return `\\\n${flags.dataChanged ? 'data ' : ''}\\\n${flags.propsChanged ? 'props ' : ''}\\\n${flags.updateTriggersChanged ? 'triggers ' : ''}\\\n${flags.viewportChanged ? 'viewport' : ''}\\\n`;\n  }\n\n  // Compares the layers props with old props from a matched older layer\n  // and extracts change flags that describe what has change so that state\n  // can be update correctly with minimal effort\n  diffProps(newProps, oldProps) {\n    const changeFlags = diffProps(newProps, oldProps);\n\n    // iterate over changedTriggers\n    if (changeFlags.updateTriggersChanged) {\n      for (const key in changeFlags.updateTriggersChanged) {\n        if (changeFlags.updateTriggersChanged[key]) {\n          this._activeUpdateTrigger(key);\n        }\n      }\n    }\n\n    return this.setChangeFlags(changeFlags);\n  }\n\n  // Called by layer manager to validate props (in development)\n  validateProps() {\n    validateProps(this.props);\n  }\n\n  setModuleParameters(moduleParameters) {\n    for (const model of this.getModels()) {\n      model.updateModuleSettings(moduleParameters);\n    }\n  }\n\n  // PRIVATE METHODS\n\n  _getUpdateParams() {\n    return {\n      props: this.props,\n      oldProps: this.internalState.getOldProps(),\n      context: this.context,\n      changeFlags: this.internalState.changeFlags\n    };\n  }\n\n  // Checks state of attributes and model\n  _getNeedsRedraw(opts) {\n    // this method may be called by the render loop as soon a the layer\n    // has been created, so guard against uninitialized state\n    if (!this.internalState) {\n      return false;\n    }\n\n    let redraw = false;\n    redraw = redraw || (this.internalState.needsRedraw && this.id);\n    this.internalState.needsRedraw = this.internalState.needsRedraw && !opts.clearRedrawFlags;\n\n    // TODO - is attribute manager needed? - Model should be enough.\n    const attributeManager = this.getAttributeManager();\n    const attributeManagerNeedsRedraw = attributeManager && attributeManager.getNeedsRedraw(opts);\n    redraw = redraw || attributeManagerNeedsRedraw;\n\n    return redraw;\n  }\n\n  // Create new attribute manager\n  _getAttributeManager() {\n    return new AttributeManager(this.context.gl, {\n      id: this.props.id,\n      stats: this.context.stats\n    });\n  }\n\n  _initState() {\n    assert(!this.internalState && !this.state);\n\n    const attributeManager = this._getAttributeManager();\n\n    if (attributeManager) {\n      // All instanced layers get instancePickingColors attribute by default\n      // Their shaders can use it to render a picking scene\n      // TODO - this slightly slows down non instanced layers\n      attributeManager.addInstanced({\n        instancePickingColors: {\n          type: GL.UNSIGNED_BYTE,\n          size: 3,\n          update: this.calculateInstancePickingColors\n        }\n      });\n    }\n\n    this.internalState = new LayerState({\n      attributeManager,\n      layer: this\n    });\n\n    this.state = {};\n    // TODO deprecated, for backwards compatibility with older layers\n    this.state.attributeManager = attributeManager;\n\n    this.internalState.onAsyncPropUpdated = this._onAsyncPropUpdated.bind(this);\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n  }\n\n  // Called by layer manager to transfer state from an old layer\n  _transferState(oldLayer) {\n    const {state, internalState} = oldLayer;\n    assert(state && internalState);\n\n    if (this === oldLayer) {\n      return;\n    }\n\n    // Move internalState\n    this.internalState = internalState;\n    this.internalState.component = this;\n\n    // Move state\n    this.state = state;\n    // Deprecated: layer references on `state`\n    state.layer = this;\n    // We keep the state ref on old layers to support async actions\n    // oldLayer.state = null;\n\n    // Ensure any async props are updated\n    this.internalState.setAsyncProps(this.props);\n\n    // Update model layer reference\n    for (const model of this.getModels()) {\n      model.userData.layer = this;\n    }\n\n    this.diffProps(this.props, this.internalState.getOldProps());\n  }\n\n  _onAsyncPropUpdated() {\n    this.diffProps(this.props, this.internalState.getOldProps());\n    this.setLayerNeedsUpdate();\n  }\n\n  // Operate on each changed triggers, will be called when an updateTrigger changes\n  _activeUpdateTrigger(propName) {\n    this.invalidateAttribute(propName);\n  }\n\n  _updateBaseUniforms() {\n    const uniforms = {\n      // apply gamma to opacity to make it visually \"linear\"\n      opacity:\n        typeof this.props.opacity === 'function'\n          ? animationProps => Math.pow(this.props.opacity(animationProps), 1 / 2.2)\n          : Math.pow(this.props.opacity, 1 / 2.2)\n    };\n    for (const model of this.getModels()) {\n      model.setUniforms(uniforms);\n    }\n  }\n\n  // DEPRECATED METHODS\n\n  // Updates selected state members and marks the object for redraw\n  setUniforms(uniformMap) {\n    for (const model of this.getModels()) {\n      model.setUniforms(uniformMap);\n    }\n\n    // TODO - set needsRedraw on the model(s)?\n    this.setNeedsRedraw();\n    log.deprecated('layer.setUniforms', 'model.setUniforms')();\n  }\n\n  use64bitProjection() {\n    log.removed('use64bitProjection', 'Fp64Extension')();\n    return false;\n  }\n}\n\nLayer.layerName = 'Layer';\nLayer.defaultProps = defaultProps;\n"],"file":"layer.js"}